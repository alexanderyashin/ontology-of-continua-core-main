# Build System Notes — Ontology of Continua Core

This document describes the full build pipeline used for the Ontology of Continua  
Core 1.1 publication shell.  
It is the canonical reference for local builds, CI builds, dependency rules,  
and failure recovery procedures.

Any modifications to the build system must be reflected here.

---

# 1. Build Overview

The project uses a **single master entry point**:

```
main.tex
```

The full document is assembled using:

- `preamble.tex` — global configuration
- `content/*.tex` — all sections
- `figures/` — figure files
- `bib/references.bib` — bibliography

The build system supports **only one engine**:

```
XeLaTeX
```

This ensures Unicode support, modern fonts, and compatibility with polyglossia.

---

# 2. Local Build Instructions

## 2.1 Dependencies

You must install:

- TeX Live 2023+ (full installation recommended)
- latexmk
- biber

### Debian / Ubuntu

```
sudo apt-get update
sudo apt-get install texlive-full latexmk biber
```

### Windows (TeX Live)

- Install TeX Live from official installer  
- Ensure `xelatex`, `latexmk`, `biber` are in PATH  
- Enable shell-escape if required

### macOS

```
brew install --cask mactex
brew install latexmk
```

---

# 3. Local Build Command

Use latexmk wrapper:

```
latexmk -xelatex main.tex -interaction=nonstopmode -output-directory=build
```

This will:

1. create `build/` directory (if not present)
2. compile `.tex → .xdv`
3. run Biber for bibliography
4. run XeLaTeX until references and TOC are stable
5. output final PDF:

```
build/main.pdf
```

---

# 4. Repository Build Structure

The build directory is structured as:

```
build/
 ├── main.pdf          # Final output
 ├── main.log          # XeLaTeX log
 ├── main.xdv          # Intermediate driver output
 ├── main.aux          # References
 ├── main.toc          # Table of contents
 ├── main.bbl          # Bibliography (generated by Biber)
 ├── logs/
 │    └── compile.log  # Copied from main.log for debugging
```

The `build/` directory is **ignored by git**, except for the `logs/` placeholder.

---

# 5. GitHub Actions CI Pipeline

The CI configuration is inside:

```
.github/workflows/build_pdf.yml
```

It performs:

1. Checkout repository  
2. Install TeX Live  
3. Run latexmk with XeLaTeX  
4. Save output PDF as an artifact  
5. Mirror metadata to Zenodo (if a release is created)

---

## 5.1 Workflow Logic (Simplified)

```
on:
  push to main
  pull_request

steps:
  - actions/checkout
  - apt install texlive-full + latexmk
  - latexmk -xelatex main.tex
  - upload build/main.pdf
```

If build succeeds:  
- Workflow status = green  
- PDF is available in "Artifacts"

If build fails:  
- Workflow is red  
- Full logs are available under "build/logs/compile.log"

---

# 6. Biber and Bibliography System

The bibliography pipeline:

```
biblatex + biber
```

Rules:

- Always use `.bib` file: `bib/references.bib`
- Never edit `.bbl` manually
- Biber runs automatically during CI

Common problems:

1. Missing commas or braces → Biber error  
2. Incorrect encoding → Biber crash  
3. Wrong citation keys → undefined references

---

# 7. Common Build Failures and Fixes

## 7.1 “Undefined references”

Cause:  
- New labels added  
- TOC changed

Fix:  
Run latexmk more than once:

```
latexmk -C
latexmk -xelatex main.tex
```

---

## 7.2 “Missing bbl file”

Cause: Biber did not run.

Fix:

```
biber main
latexmk -xelatex main.tex
```

---

## 7.3 “Engine mismatch: fontspec requires XeLaTeX”

Cause: Wrong engine (pdflatex).

Fix: Use:

```
latexmk -xelatex main.tex
```

---

## 7.4 “Package polyglossia error: missing language”

Cause: corrupted TeX Live

Fix:

```
sudo apt-get install texlive-lang-european
sudo apt-get install texlive-lang-cyrillic
```

---

# 8. Do-Not-Touch Zones

The following files must **not** be modified without strong reason:

```
preamble.tex          # global config for all future cores
build_pdf.yml         # CI stability layer
.zenodo.json          # metadata synchronization
```

Touching these incorrectly can break:

- PDF builds
- Zenodo DOI updates
- Cross-repository template inheritance

---

# 9. Adding New Build Features (Rules)

If adding tooling, you MUST:

1. Document it in this file  
2. Ensure CI builds locally  
3. Ensure CI builds remotely  
4. Ensure it remains compatible with TeX Live 2023+  
5. Ensure XeLaTeX remains the default engine

---

# 10. Full Build Workflow Summary

**Local developer workflow**

```
edit → git commit → latexmk -xelatex main.tex → check PDF → push
```

**CI workflow**

```
push → GitHub Actions → TeX Live → XeLaTeX → PDF artifact
```

**Release workflow**

```
create GitHub Release → Zenodo automatic capture → DOI update
```

This guarantees:

- reproducibility  
- traceability  
- archival stability  
- automated distribution  

---

# 11. Final Checklist Before Release

Before tagging a release:

- [ ] All sections compile
- [ ] No undefined references
- [ ] Biber runs cleanly
- [ ] PDF builds identical locally & via CI
- [ ] Zenodo metadata (.zenodo.json) is correct
- [ ] README.md updated
- [ ] Version number consistent

---

