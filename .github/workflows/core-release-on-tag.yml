name: Core — Build & Release on tag

on:
  push:
    tags:
      - "v*"

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write   # важно для создания релиза и загрузки assets

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # TeX-Umgebung installieren
      - name: Install TeX Live (full)
        run: |
          sudo apt-get update
          sudo apt-get install -y texlive-full latexmk

      - name: Make build_core.sh executable
        run: chmod +x ./build_core.sh

      - name: Build Core PDF
        run: ./build_core.sh

      - name: Find built PDF
        id: find_pdf
        run: |
          PDF_PATH=$(find build -maxdepth 1 -name "*.pdf" | head -n 1)
          if [ -z "$PDF_PATH" ]; then
            echo "No PDF found in build/"
            exit 1
          fi
          echo "Found PDF at: $PDF_PATH"
          echo "pdf_path=$PDF_PATH" >> "$GITHUB_OUTPUT"

      - name: Create source archive (ZIP)
        id: make_zip
        run: |
          TAG="${GITHUB_REF_NAME}"
          ZIP_NAME="core-${TAG}-source.zip"
          echo "Creating $ZIP_NAME"
          zip -r "$ZIP_NAME" . \
            -x ".git/*" \
               ".github/*" \
               "build/*"
          echo "zip_name=$ZIP_NAME" >> "$GITHUB_OUTPUT"

      - name: Create GitHub release and upload assets
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          name: Ontology of Continua — Core ${{ github.ref_name }}
          draft: false
          prerelease: false
          body: |
            Ontology of Continua — Core ${{ github.ref_name }}

            This release was built automatically from tag ${{ github.ref_name }}.
            It includes:
            - Compiled PDF (XeLaTeX build)
            - Source ZIP (LaTeX + build pipeline)

            If this repository is linked to Zenodo, publishing this release
            will automatically trigger a new Zenodo record / version using zenodo.json metadata.
          files: |
            ${{ steps.find_pdf.outputs.pdf_path }}
            ${{ steps.make_zip.outputs.zip_name }}
